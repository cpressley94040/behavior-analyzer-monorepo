name: Build Lambda Layer

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/build-lambda-layer.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish layer to AWS Lambda'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-2
  LAYER_NAME: behavior-analyzer

jobs:
  build:
    name: Build Lambda Layer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Lambda Layer in Docker
        run: |
          cd backend/python/lambda
          chmod +x build_layer.sh
          ./build_layer.sh

      - name: Verify layer contents
        run: |
          cd backend/python/lambda/output
          echo "Layer zip contents:"
          unzip -l behavior_analyzer_layer.zip

          # Verify expected files exist
          unzip -t behavior_analyzer_layer.zip | grep -q "__init__.py" || (echo "Missing __init__.py" && exit 1)
          unzip -t behavior_analyzer_layer.zip | grep -q ".so" || (echo "Missing .so file" && exit 1)

          echo "Layer size:"
          ls -lh behavior_analyzer_layer.zip

      - name: Upload layer artifact
        uses: actions/upload-artifact@v4
        with:
          name: behavior-analyzer-layer
          path: backend/python/lambda/output/behavior_analyzer_layer.zip
          retention-days: 30

      - name: Upload layer to S3 (for Amplify)
        if: github.ref == 'refs/heads/main' || github.event.inputs.publish == 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Upload to S3 for Amplify to use
          aws s3 cp backend/python/lambda/output/behavior_analyzer_layer.zip \
            s3://${{ secrets.LAYER_BUCKET }}/layers/behavior-analyzer/latest.zip

          # Also upload with version tag
          VERSION=$(date +%Y%m%d-%H%M%S)
          aws s3 cp backend/python/lambda/output/behavior_analyzer_layer.zip \
            s3://${{ secrets.LAYER_BUCKET }}/layers/behavior-analyzer/${VERSION}.zip

  publish:
    name: Publish Lambda Layer
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.publish == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download layer artifact
        uses: actions/download-artifact@v4
        with:
          name: behavior-analyzer-layer
          path: ./layer

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Publish Lambda Layer
        id: publish
        run: |
          # Publish the layer
          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name ${{ env.LAYER_NAME }} \
            --description "Behavior Analyzer C++ Python bindings ($(date +%Y-%m-%d))" \
            --license-info "MIT" \
            --compatible-runtimes python3.11 \
            --compatible-architectures x86_64 \
            --zip-file fileb://./layer/behavior_analyzer_layer.zip \
            --output text \
            --query 'Version')

          echo "Published layer version: ${LAYER_VERSION}"
          echo "version=${LAYER_VERSION}" >> $GITHUB_OUTPUT

          # Get the layer ARN
          LAYER_ARN=$(aws lambda get-layer-version \
            --layer-name ${{ env.LAYER_NAME }} \
            --version-number ${LAYER_VERSION} \
            --output text \
            --query 'LayerVersionArn')

          echo "Layer ARN: ${LAYER_ARN}"
          echo "arn=${LAYER_ARN}" >> $GITHUB_OUTPUT

      - name: Add layer permission for all accounts (public)
        if: false  # Set to true if you want to make the layer public
        run: |
          aws lambda add-layer-version-permission \
            --layer-name ${{ env.LAYER_NAME }} \
            --version-number ${{ steps.publish.outputs.version }} \
            --statement-id public \
            --action lambda:GetLayerVersion \
            --principal '*'

      - name: Update layer version in Amplify
        run: |
          # Store the layer ARN for Amplify deployment
          echo "BEHAVIOR_ANALYZER_LAYER_ARN=${{ steps.publish.outputs.arn }}" >> $GITHUB_ENV

          # Could also update SSM parameter for automatic pickup
          # aws ssm put-parameter \
          #   --name /behavior-analyzer/layer-arn \
          #   --value "${{ steps.publish.outputs.arn }}" \
          #   --type String \
          #   --overwrite

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: layer-v${{ steps.publish.outputs.version }}
          name: Lambda Layer v${{ steps.publish.outputs.version }}
          body: |
            ## Behavior Analyzer Lambda Layer

            **Version:** ${{ steps.publish.outputs.version }}
            **ARN:** `${{ steps.publish.outputs.arn }}`

            ### Usage

            Add to your Lambda function:
            ```python
            from behavior_analyzer import ZScoreDetector, MetricVector
            ```

            ### Included Components
            - Core types: Entity, Event, MetricVector, Anomaly
            - Detectors: ZScore, IsolationForest, EWMA, CUSUM, Seasonal, HoltWinters, ARIMA
            - Multivariate: Mahalanobis, PCA, OneClassSVM
            - Scoring: StreamingRiskScorer
          files: |
            layer/behavior_analyzer_layer.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test Python Bindings
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download layer artifact
        uses: actions/download-artifact@v4
        with:
          name: behavior-analyzer-layer
          path: ./layer

      - name: Extract and install layer
        run: |
          mkdir -p layer-content
          unzip layer/behavior_analyzer_layer.zip -d layer-content

          # Add to Python path
          export PYTHONPATH="${PWD}/layer-content/python/lib/python3.11/site-packages:${PYTHONPATH}"
          echo "PYTHONPATH=${PYTHONPATH}" >> $GITHUB_ENV

      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio

      - name: Run binding tests
        run: |
          cd backend/python/tests
          python -m pytest test_bindings.py -v --tb=short
        env:
          PYTHONPATH: ${{ env.PYTHONPATH }}

  notify:
    name: Notify on Failure
    needs: [build, publish, test]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "⚠️ Lambda Layer build failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Lambda Layer Build Failed*\n\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
